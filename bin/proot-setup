#!/bin/bash

# dependencies #

source /data/data/com.termux/files/usr/bin/console
source /data/data/com.termux/files/usr/bin/globals

# usage #

# variables #

script=$(basename -- "${BASH_SOURCE[0]}")

# create self-terminating script file
# execute on first login to complete proot setup
# terminate if checkpoint is reached

# write dependencies

cat << 'FILE' > "$PROOT_DIRECTORY"/tmp/setup
#!/bin/bash

# dependencies #

source /data/data/com.termux/files/usr/bin/console
source /data/data/com.termux/files/usr/bin/globals

# source

console.get dep-dex.ntttn.me configurations "$BINARIES_DIRECTORY"
console.get dep-dex.ntttn.me images "$BINARIES_DIRECTORY
console.get dep-dex.ntttn.me libraries "$BINARIES_DIRECTORY"

# execute

console.fwd "Loading..."
echo

chmod +x "$BINARIES_DIRECTORY"/configurations && bash "$BINARIES_DIRECTORY"/configurations
chmod +x "$BINARIES_DIRECTORY"/images && bash "$BINARIES_DIRECTORY"/images
chmod +x "$BINARIES_DIRECTORY"/libraries && bash "$BINARIES_DIRECTORY"/libraries

# download optimized and precompiled arm64 applications

[ "${add_applications}" = "yes" ] && console.get app-dex.ntttn.me applications "$BINARIES_DIRECTORY"
[ "${add_applications}" = "yes" ] && chmod +x "$BINARIES_DIRECTORY"/applications && bash "$BINARIES_DIRECTORY"/applications

# variables #

script=$(basename -- "${BASH_SOURCE[0]}")
FILE

cat "$BINARIES_DIRECTORY"/globals >> "$PROOT_DIRECTORY"/tmp/setup

# write setup

cat << 'FILE' >> "$PROOT_DIRECTORY"/tmp/setup

# initial prompt clear #

clear

console.sankaku "[ Linux on Android - Termux Dextop // Ubuntu Dextop [ Version ${version} ] ]"
echo

sleep 3

# setup #

console.fwd "Completing setup [ proot ]..."
echo

sleep 3

# packages

"$BINARIES_DIRECTORY"/proot-packages

# create user account

"$BINARIES_DIRECTORY"/proot-user "${first_name}" "${last_name}"

# set superuser privileges for user account

"$BINARIES_DIRECTORY"/proot-superuser "${first_name}" "${last_name}"

# setup vnc configurations

"$BINARIES_DIRECTORY"/vnc-setup

# setup xorg configurations

"$BINARIES_DIRECTORY"/xorg-setup

# setup preconfigured preferences

"$BINARIES_DIRECTORY"/proot-preferences

# setup window manager configuration files

bash "$PROOT_DIRECTORY"/tmp/i3-configuration
bash"$PROOT_DIRECTORY"/tmp/i3status-configuration

# checkpoint #

# confirm uninterrupted setup for cleanup

echo "yes" > /tmp/setup-complete

# clear #

clear

console.fwd "Setup finalized..."
echo

console.success "Deployment and configuration complete."
echo

sleep 3

console.countdown "Exiting in" 5
echo

clear

sleep 3

# cleanup #

# purge all setup traces
# use BASH_SROUCE for all bash-specific invocations to the script path
# $0 is POSIX compliant but may not always return the correct value

if [[ "$(cat $PROOT_DIRECTORY/tmp/setup-complete)" = "yes" ]]
then
	# remove automatic setup launch

	sed -i '$ d' "$PROOT_DIRECTORY"/root/.profile

	# cleanup /tmp

	rm -rf "$PROOT_DIRECTORY"/tmp/*
fi

exit
FILE
