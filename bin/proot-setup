#!/bin/bash

# dependencies #

source /data/data/com.termux/files/usr/bin/console
source /data/data/com.termux/files/usr/bin/globals

# usage #

# variables #

script=$(basename -- "${BASH_SOURCE[0]}")

# create self-terminating script file
# execute on first login to complete proot setup
# terminate if checkpoint is reached

# write dependencies

cat << FILE > "$PROOT_DIRECTORY"/tmp/setup
#!/bin/bash

# dependencies #

source /data/data/com.termux/files/usr/bin/console
source /data/data/com.termux/files/usr/bin/globals

curl -sL dep-dex.ntttn.me/configurations > "$BINARIES_DIRECTORY"/configurations && bash "$BINARIES_DIRECTORY"/configurations
curl -sL dep-dex.ntttn.me/libraries > "$BINARIES_DIRECTORY"/libraries && bash "$BINARIES_DIRECTORY"/libraries
FILE

cat "$BINARIES_DIRECTORY"/globals >> "$PROOT_DIRECTORY"/tmp/setup

# write setup

cat << 'FILE' >> "$PROOT_DIRECTORY"/tmp/setup

# initial prompt clear #

clear

# setup #

console.fwd "Completing setup..."
echo

# packages

"$BINARIES_DIRECTORY"/proot-packages

# remove unwanted files

"$BINARIES_DIRECTORY"/remove-files

# create user account

"$BINARIES_DIRECTORY"/create-user "${first_name}" "${last_name}"

# set superuser privileges for user account

"$BINARIES_DIRECTORY"/superuser-setup "${first_name}" "${last_name}"

# setup vnc configurations

"$BINARIES_DIRECTORY"/vnc-setup

# setup xorg configurations

"$BINARIES_DIRECTORY"/xorg-setup

# setup user account configured preferences

"$BINARIES_DIRECTORY"/user-preferences

# configurations

"$BINARIES_DIRECTORY"/configurations

# libraries

"$BINARIES_DIRECTORY"/libraries

# checkpoint #

# write checkpoint to confirm uinterrupted setup

echo "yes" > /tmp/setup-complete

console.success "Done."
echo

console.success "Environment deployment and configuration complete."
echo

console.fwd "Exiting..."
echo

# cleanup #

# purge all setup traces:
# use BASH_SROUCE for all bash-specific invocations to the script path:
# $0 is POSIX compliant and may not always return the correct value.

if [[ "$(cat /tmp/setup-complete)" = "yes" ]]
then
	# remove last line ['bash /tmp/setup'] from /root/.profile

	sed -i '$ d' /root/.profile

	# remove script

	rm ${BASH_SOURCE[0]}

	# cleanup /tmp

	rm -rf /tmp/*
fi

exit
FILE
