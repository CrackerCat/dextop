#!/bin/bash

# dependencies #

source /data/data/com.termux/files/usr/bin/console
source /data/data/com.termux/files/usr/bin/globals

# create self-terminating script file
# execute on first login to complete proot setup
# terminates when checkpoint is reached

console.info "Generating initial login environemnt setup scripts."
echo

# write dependencies

cat << FILE > "$PROOT_DIRECTORY"/tmp/setup
#!/bin/bash

# dependencies #

source /data/data/com.termux/files/usr/bin/console
source /data/data/com.termux/files/usr/bin/globals
FILE

cat "$BINARIES_DIRECTORY"/globals >> "$PROOT_DIRECTORY"/tmp/setup

# write setup

cat << 'FILE' >> "$PROOT_DIRECTORY"/tmp/setup

# initial prompt clear #

clear

# setup #

console.fwd "Completing setup..."
echo

# packages

"$BINARIES_DIRECTORY"/proot-packages

# remove unwanted files

"$BINARIES_DIRECTORY"/remove-files

# create user account

"$BINARIES_DIRECTORY"/create-user "${first_name}" "${last_name}"

# set superuser privileges for user account

"$BINARIES_DIRECTORY"/superuser-setup "${first_name}" "${last_name}"

# setup user account session elements and configured preferences

"$BINARIES_DIRECTORY"/session-setup

# checkpoint #

# write value to confirm uinterrupted setup completion

echo "yes" > /tmp/setup-complete

console.success "Done."
echo

console.success "Environment deployment and configuration complete."
echo

console.fwd "Exiting..."
echo

# cleanup #

# purge all setup traces:
# use BASH_SROUCE for all bash-specific invocations to the script path:
# $0 is POSIX compliant and may not always return the correct value.

if [[ "$(cat /tmp/setup-complete)" = "yes" ]]
then
	# remove last line ['bash /tmp/setup'] from /root/.profile

	sed -i '$ d' /root/.profile

	# remove script

	rm ${BASH_SOURCE[0]}

	# cleanup /tmp

	rm -rf /tmp/*
fi

exit
FILE
