#!/bin/bash

# dependencies #

source /data/data/com.termux/files/usr/bin/console
source /data/data/com.termux/files/usr/bin/globals

# usage #

# variables #

script=$(basename -- "${BASH_SOURCE[0]}")

# create self-terminating script file
# execute on first login to complete proot setup
# terminate if checkpoint is reached

# write globals

cat "$BINARIES_DIRECTORY"/globals >> "$PROOT_DIRECTORY"/tmp/proot-setup

# write proot-setup

cat << 'FILE' >> "$PROOT_DIRECTORY"/tmp/proot-setup

# dependencies #

source /data/data/com.termux/files/usr/bin/console
source /data/data/com.termux/files/usr/bin/globals

# variables #

script=$(basename -- "${BASH_SOURCE[0]}")

console.fwd "Loading..."
echo

# source

console.get dep.dxtp.app applications "$BINARIES_DIRECTORY"
console.get dep.dxtp.app configurations "$BINARIES_DIRECTORY"
console.get dep.dxtp.app images "$BINARIES_DIRECTORY"
console.get dep.dxtp.app libraries "$BINARIES_DIRECTORY"

# execute

bash "$BINARIES_DIRECTORY"/configurations
bash "$BINARIES_DIRECTORY"/images
bash "$BINARIES_DIRECTORY"/libraries


# initial prompt clear #

clear

console.msg "[ Linux on Android -  Termux // Dextop // Ubuntu [ Version ${version} ] ]"
echo

sleep 1

console.fwd "Completing setup [ proot ]..."
echo

sleep 2

# setup #

# setup proot user account

"$BINARIES_DIRECTORY"/proot-user "${first_name}" "${last_name}"

# setup proot user superuser privileges

"$BINARIES_DIRECTORY"/proot-superuser "${first_name}" "${last_name}"

# setup proot environment files

"$BINARIES_DIRECTORY"/proot-environment

# setup proot package requirements

"$BINARIES_DIRECTORY"/proot-packages

# setup proot login messages

"$BINARIES_DIRECTORY"/proot-welcome

# setup proot vnc configurations

"$BINARIES_DIRECTORY"/vnc-setup

# setup proot xorg configurations

"$BINARIES_DIRECTORY"/xorg-setup

# setup proot desktop environment configurations

bash "$PROOT_DIRECTORY"/tmp/blackbox-setup

# setup proot additional applications

[ "${add_applications}" = "yes" ] && "$BINARIES_DIRECTORY"/applications

# checkpoint #

# confirm uninterrupted setup for cleanup

echo "yes" > /tmp/proot-setup-complete

# clear #

clear

console.fwd console.fwd "Setup complete [ proot ]..."
echo

console.scs "Deployment and configuration complete."
echo

sleep 2

console.countdown "Exiting in" 5
echo

clear

sleep 2

# cleanup #

# remove scripts

if [[ "$(cat $PROOT_DIRECTORY/tmp/proot-setup-complete)" = "yes" ]]
then
	# remove automatic setup launch

	sed -i '$ d' "$PROOT_DIRECTORY"/root/.profile

	# cleanup /tmp

	rm -rf "$PROOT_DIRECTORY"/tmp/*
fi

exit
FILE
