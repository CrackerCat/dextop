#!/bin/bash

# dependencies #

source /data/data/com.termux/files/usr/bin/console
source /data/data/com.termux/files/usr/bin/globals

# verify termux storage directory existence

if [ -d "$HOME"/storage ]
then
	# exists - proceed with setup
	
	console.success "Storage directory detected under"
	console.success "$HOME"
	echo
	
	console.fwd "Continuing..."
	echo
else
	# does not exist - enable storage permissions: requires user touch input
	

	console.warning "Termux requires user permission to access storage on this device:"
	echo
	console.info "Both internal and external storage is made available."
	console.info "Allowing access greatly benefits the desktop experience"
	console.info "and will make the device's storage visble and accessible"
	console.info "through your desktop session and file manager."
	echo
	console.warning "Select 'Allow' or 'Deny' when prompted to enable or disable storage access permission."
	echo

	sleep 10
	
	# trigger storage permissions dialog
	
	# am broadcast	--user 0 \
	#				--es com.termux.app.reload_style storage \
	#				-a com.termux.app.reload_style com.termux > /dev/null

	termux-setup-storage

	# wait 5 seconds to permit storage permissions approval

	console.countdown 5
fi

# remove storage link defaults

rm -rf "$HOME"/storage

# create new storage mount location

mkdir -p "$SETUP_DIRECTORY"/storage

# create new symbolic links for bind mounts

ln -s -f /storage/emulated/0 "$SETUP_DIRECTORY"/storage/internal || :
	
# match sdcard UUID
# use regular expression to match label XXXX-XXXX

sd_uuid=$(echo $(ls /storage | sed -r '/[A0-Z9][-][A0-Z9]/!d'))

if [ ! -z "${sd_uuid}" ]
then
	console.success "External storage found:"
	console.info "UUID:......: ${sd_uuid}"
	echo
	
	console.fwd "Linking..."
	echo

	ln -s -f /storage/"${sd_uuid}" "$SETUP_DIRECTORY"/storage/external || :

else
	console.error "External storage not found or not present:"
	console.info "Could not find extrernal storage media mounted under /storage."
	echo
	
	console.fwd "Continuing..."
	echo
fi
